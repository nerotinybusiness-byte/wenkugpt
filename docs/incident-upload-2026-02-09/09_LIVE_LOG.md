# Live Log

Use this file as append-only progress log.

## 2026-02-09
- Created incident documentation bundle for cross-window continuity.
- Confirmed root cause path: missing `x-user-email` in client fetch calls.
- Confirmed production ingest works when header is provided manually.
- Confirmed parser file has local modifications under active validation.
- User requested explicit implementation plan before code fix execution.
- User requested continuous markdown evidence across chat windows.
- Added implementation tracker and conversation context docs to support that process.
- Locked next action: implement shared client API helper and migrate target fetch call sites.
- Implemented shared helper `src/lib/api/client-request.ts` with identity resolution and `apiFetch`.
- Migrated API calls in `src/components/ingest/FileUploader.tsx`.
- Migrated API calls in `src/components/ingest/FileList.tsx`.
- Migrated API calls in `src/components/chat/ChatPanel.tsx`.
- Ran verification gates:
  - `npx tsc --noEmit --incremental false` passed.
  - `npm run test:run` passed (27 tests).
  - `npm run build` passed.
- Current status: ready for runtime validation (local browser + production browser).
- Deployed production build:
  - `https://wenkugpt-copy-96rf8aw2g-nerotinys-projects.vercel.app`
  - Alias `https://wenkugpt-copy.vercel.app` points to this deployment.
- Production ingest API smoke check with header passed:
  - `POST /api/ingest` returned `success: true`.
- Production history API smoke checks:
  - With header: `GET /api/history?limit=1` returned `success: true`.
  - Without header: `GET /api/history?limit=1` returned `AUTH_UNAUTHORIZED`.
- Remaining validation: browser-based upload/chat flow confirmation with new frontend header injection.
- Added temporary compatibility fallback in client helper when env/storage identity is missing:
  - fallback email: `admin@example.com`.
- Re-ran verification gates after fallback change:
  - `npx tsc --noEmit --incremental false` passed.
  - `npm run test:run` passed (27 tests).
  - `npm run build` passed.
- Deployed updated build:
  - `https://wenkugpt-copy-jh17adf7h-nerotinys-projects.vercel.app`
  - Alias `https://wenkugpt-copy.vercel.app` now points to this deployment.
- Re-ran production API smoke checks:
  - `POST /api/ingest` with header returned `success: true`.
  - `GET /api/history?limit=1` with header returned `success: true`.
  - `GET /api/history?limit=1` without header returned `AUTH_UNAUTHORIZED`.
- Remaining validation: explicit browser UX check (upload/chat/list/delete/preview) on the deployed frontend.
- User reported confusing file names in library (storage key visible in UI).
- Root cause confirmed: ingest stores `filename` as internal storage key format `userId_uuid_safeFilename`.
- UI refinement implemented in `src/components/ingest/FileList.tsx`:
  - display now strips technical prefix when pattern matches UUID_UUID_name.
  - filtering now works with both display filename and raw stored filename.
  - preview modal title uses cleaned display filename.
- Re-ran local gates after UI refinement:
  - `npx tsc --noEmit --incremental false` passed.
  - `npm run test:run` passed (27 tests).
  - `npm run build` passed.
- Deployed UI filename refinement:
  - `https://wenkugpt-copy-22h90gzbc-nerotinys-projects.vercel.app`
  - alias `https://wenkugpt-copy.vercel.app` updated.

- Closed UI/docs follow-up:
  - fixed chat history class typo `truncat` -> `truncate` in `src/components/chat/ChatPanel.tsx`.
  - removed obsolete `ALLOW_HEADERLESS_AUTH` from `.env.example`.
  - documented unsupported status of `ALLOW_HEADERLESS_AUTH` in `README.md` and `docs/api.md`.
  - updated risk register entry for env/docs drift as resolved.
- EOD handoff prepared for 2026-02-10: `17_EOD_HANDOFF_2026-02-09.md` with summary, open items, and restart checklist.

## 2026-02-10
- Started RAG v2 implementation track (`Slang-aware Context Graph Memory`) on branch `feat/rag-engine-switch`.
- Added dedicated v2 documentation and append-only live log under `docs/rag-v2/`.
- Implemented v2 graph-memory schema + migration, query flow scaffolding, feature flags, and API wiring.
- Extended Settings payload for scoped/temporal/ambiguity controls.
- Validation after v2 implementation:
  - `npx tsc --noEmit --incremental false` passed.
  - `npm run lint` passed.
  - `npm run test:run` passed (32 tests).
- Started end-to-end PDF highlight precision remediation after user approval:
  - decision confirmed: full code fix + full document reupload/reingest.
  - implemented ingest matching hardening in `src/lib/ingest/chunker.ts` (page-local block matching).
  - implemented highlight metadata hardening in `src/lib/ingest/pipeline.ts` (sanitize/dedupe/merge/cap).
  - implemented viewer hardening in `src/components/chat/PDFViewer.tsx`:
    - coarse detection for multi-box highlight sets
    - tighter context-text fallback thresholding
    - visible highlight mode label (`bbox` vs `context-text`)
  - improved citation context composition in `src/components/chat/ChatMessage.tsx`.
  - expanded diagnostics in `scripts/check_bboxes.ts` to include highlight box density/coarse indicators.
  - added regression tests:
    - `src/lib/ingest/__tests__/chunker.test.ts` (page-local sourceBlocks)
    - `src/components/chat/__tests__/pdfHighlightUtils.test.ts`
- Current status: implementation in progress; static/test gate run pending; runtime validation pending reupload.
- Ran static/test gates for remediation branch:
  - `npx tsc --noEmit --incremental false` passed.
  - `npm run lint` passed.
  - `npm run test:run` passed (38 tests).
  - `npm run build` passed.
- Current status: code changes and automated gates are green; pending runtime validation after document reupload/reingest.
- Executed data reset and reingest workflow:
  - `node scripts/clear_docs.js` completed.
  - `node scripts/check_files.js` confirmed `Total documents in DB: 0`.
  - Supabase bucket `documents` list confirmed `74` objects, `72` supported (`.pdf/.txt`).
  - Bulk reingest via `processPipeline` from storage completed `72/72` success, `0` failures.
  - DB post-check after dedupe: `22` unique documents.
- Smoke retrieval check run for query `kde je sklad wenku?`:
  - retrieval returned relevant Wenku sources and address snippets (`Na Hanspaulce ...`).
  - source highlight metadata still classified as coarse on several top hits, but no ingest/runtime failures.
- Root cause refinement found in viewer fallback:
  - context-text narrowing in `PDFViewer` previously attempted only once after 220ms.
  - when text layer was not ready in that window, coarse highlight fallback persisted.
- Implemented viewer hotfix in `src/components/chat/PDFViewer.tsx`:
  - retry loop for context-text highlight resolution.
  - temporary suppression of coarse overlay while refinement is in progress.
  - status chip `Refining highlight...` during narrowing.
- Re-ran validation after hotfix:
  - `npx tsc --noEmit --incremental false` passed.
  - `npm run test:run` passed (38 tests).
- Current status: reingest + smoke checks complete; final manual browser confirmation of citation highlight precision is pending.
- Additional root-cause review confirmed a second-order issue:
  - viewer can report `context-text` while highlight is mis-anchored (thin top strip) on known problematic PDF page.
- Implementation started for deep-fix track (dual-read + spatial gate):
  - added `highlightText` plumbing in source payload types and chat API mapping.
  - added DB migration scaffold for `chunks.highlight_text`.
  - added ingest snippet generation for `highlight_text`.
  - rewired viewer context cache key to page + normalized context + highlight signature.
  - replaced global lexical span resolver with region-first resolver + spatial validation gate.
  - added deterministic `bbox-fallback` mode and debug reason codes (`context_no_tokens`, `context_no_ranked_spans`, `context_spatial_gate_fail`, `context_bbox_fallback`).
  - added unit tests for geometry/signature helpers and chat context payload helpers.
- Validation after deep-fix implementation:
  - `npx tsc --noEmit --incremental false` passed.
  - `npm run lint` passed.
  - `npm run test:run` passed (`45/45`).
  - `npm run build` passed.
- Current status: code and automated gates are green; remaining work is browser regression matrix on known problematic citation flow.
- Incident follow-up started for ingest runtime failure (`chunks.highlight_text`):
  - confirmed real DB error code `42703` with message `column "highlight_text" does not exist`.
  - verified production `chunks` schema had `highlight_boxes` but missing `highlight_text`.
- Production restore actions executed:
  - applied SQL hotfix: `ALTER TABLE public.chunks ADD COLUMN IF NOT EXISTS highlight_text text;`
  - verified column presence via `information_schema.columns`.
  - verified read query: `select highlight_text from public.chunks limit 1` succeeds.
  - production ingest smoke (`POST /api/ingest` with admin header) returned `200` + `success: true`.
- Hardening implementation started:
  - added ingest schema preflight module (`src/lib/db/schema-health.ts`) with 60s cache.
  - wired preflight assertion into `src/app/api/ingest/route.ts` before storage/upload pipeline.
  - improved error mapping for PG `42703` (`highlight_text`) and added dedicated response code path `INGEST_SCHEMA_MISMATCH`.
  - added guardrail script `scripts/check_ingest_schema.ts` + npm command `db:check-ingest-schema`.
  - added test coverage for schema health and ingest error mapping.
- Validation after hardening implementation:
  - `npm run db:check-ingest-schema` passed.
  - `npx tsc --noEmit --incremental false` passed.
  - `npm run lint` passed.
  - `npm run test:run` passed (`50/50`).
  - `npm run build` passed.
- Deployment + post-deploy verification:
  - committed and pushed hardening patch: `5de6f53`.
  - production deployment: `https://wenkugpt-copy-g1jaynxhr-nerotinys-projects.vercel.app` (`Ready`).
  - alias `https://wenkugpt-copy.vercel.app` updated.
  - post-deploy ingest smoke (`POST /api/ingest` with admin header) returned `200` + `success: true`.
- Current status: schema drift hotfix and ingest hardening are deployed and verified; monitor-only phase remains.

- Started and completed local implementation track for template-aware PDF ingest (`Template-Aware PDF Ingest Proti Zmateni Chatu`):
  - added template detection module with profile registry, 10% page sampling (`min 3`, `max 12`), visual/token fingerprints, and optional Gemini OCR fallback:
    - `src/lib/ingest/template.ts`
    - `config/template-profiles/wenku-manual-v1.json`
    - `scripts/build_template_profile.ts`
  - integrated template diagnostics and boilerplate classification into ingest pipeline:
    - `src/lib/ingest/pipeline.ts`
    - diagnostics persisted on `documents` (`templateProfileId`, `templateMatched`, `templateMatchScore`, `templateBoilerplateChunks`, `templateDetectionMode`, `templateWarnings`)
    - boilerplate chunks marked via `chunks.is_template_boilerplate`
    - boilerplate chunks excluded from embedding/FTS writes.
  - added retrieval exclusion with rollout-safe feature flag guard:
    - `src/lib/db/queries.ts` now filters boilerplate chunks only when `TEMPLATE_AWARE_FILTERING_ENABLED=true`.
  - expanded ingest and documents API payloads:
    - `POST /api/ingest` returns `data.template` diagnostics and supports `options.templateProfileId`.
    - `GET /api/documents` returns template diagnostics fields.
  - updated ingest/file-management UI:
    - upload success status now surfaces template warnings/summary.
    - document list surfaces template match metadata and warning/failure detail.
  - added schema + migration:
    - `drizzle/0005_template_aware_ingest.sql`
    - updated schema preflight checks for new required columns (`chunks` + `documents`).
  - docs/env updates:
    - `docs/api.md`, `README.md`, `.env.example`.
- Validation after template-aware implementation:
  - `npx tsc --noEmit --incremental false` passed.
  - `npm run lint` passed.
  - `npm run lint:scripts` passed.
  - `npm run test:run` passed (`54/54`).
- Current status:
  - code + tests complete locally.
  - pending operational rollout steps: apply DB migration `0005_template_aware_ingest.sql`, generate/tune reference profile from production PDF corpus, enable template feature flags gradually in preview/production.
## Next log entry template
- Date:
- Change made:
- Files touched:
- Verification run:
- Result:
- New risk or blocker:
- Next action:

## 2026-02-11
- Implemented OCR engine switch for empty/low chunk rescue with user-level setting (`gemini`/`tesseract`) and locked no-fallback policy.
- Added ingest option + response contract fields:
  - request: `emptyChunkOcrEngine`
  - response: `ocrRescue.engine`, `ocrRescue.fallbackEngine`, `ocrRescue.engineUsed`
- Added documents metadata fields:
  - `ocrRescueEngine`, `ocrRescueFallbackEngine`
- Added DB migration for OCR engine metadata:
  - `drizzle/0007_ocr_engine_switch.sql`
- Added provider abstraction and Tesseract backend path:
  - `src/lib/ingest/ocr-provider.ts`
  - `src/lib/ingest/ocr-tesseract.ts`
  - `src/lib/ingest/ocr.ts` (Gemini provider export + unified failure mapping)
- Pipeline wiring updated for engine-aware rescue + telemetry payload keys:
  - `ingest_ocr_engine_usage`
  - `ingest_ocr_engine_fallback_rate`
  - `ingest_ocr_rescue_success_rate_by_engine`
  - `ingest_ocr_latency_ms`
  - `ingest_ocr_warning_codes`
- Added/expanded test coverage:
  - `ocr-provider.test.ts`
  - `ocr-tesseract.test.ts`
  - ingest route options/get tests
  - documents pagination test
  - schema-health test
- Validation gates completed after OCR engine switch implementation:
  - `npx tsc --noEmit --incremental false` passed.
  - `npm run lint` passed.
  - `npm run test:run` passed (`75/75`).
  - `npm run build` passed.
- Current status: OCR engine switch changes are implemented and locally validated; migration `0007` rollout on target DB remains.

- Executed production DB schema alignment for ingest/template/OCR tracks:
  - applied SQL migrations on production DB: `0005_template_aware_ingest.sql`, `0006_empty_chunk_ocr_rescue.sql`, `0007_ocr_engine_switch.sql`.
  - verified schema health via `npm run db:check-ingest-schema` -> `ingest_schema_ok=true` with no missing columns.
- Ran production ingest smoke matrix on aliased app `https://wenkugpt-copy.vercel.app`:
  - OCR rescue OFF: `POST /api/ingest` returned `200`, `success=true`, warning `ocr_rescue_disabled`.
  - OCR rescue ON + engine `gemini`: `POST /api/ingest` returned `200`, `success=true`.
  - OCR rescue ON + engine `tesseract`: `POST /api/ingest` returned `200`, `success=true`; provider-unavailable path stayed warning-only (`ocr_rescue_tesseract_unavailable`).
  - `GET /api/documents?limit=1` returned `200`, `success=true`, and OCR metadata fields were readable (`ocrRescueEngine`, `ocrRescueFallbackEngine`).
- Deployed latest production build:
  - deployment id: `dpl_FjkzRouUgBSRjfyFCBYUr3m1H9EF`
  - deployment URL: `https://wenkugpt-copy-2a7ezi84x-nerotinys-projects.vercel.app`
  - alias `https://wenkugpt-copy.vercel.app` points to this deployment.
- Current status: production schema and OCR engine rollout are aligned; final browser UX regression and telemetry monitoring continue.
- Implemented ingest hardening for scan/image-only PDFs with weak text extraction:
  - added OCR re-chunk fallback path (`minTokens=1`) when OCR returns short text but standard chunking yields `0` chunks.
  - added warning code `ocr_rescue_short_text_fallback_chunk`.
  - document persistence now marks ingest as `failed` when final `chunkRecords.length === 0` with explicit `processingError` (`No indexable text extracted from document (OCR produced no usable text).`).
  - added final ingest telemetry/log fields for debugging: `chunk_count_after_ocr`, `document_final_status`.
- Implemented preview API clarity for empty/failed docs:
  - `GET /api/documents/[id]/preview` now loads document metadata first.
  - returns `DOCUMENT_NOT_FOUND` when document does not exist.
  - returns `DOCUMENT_PREVIEW_EMPTY` (409) for existing `failed` docs without chunks.
- Updated ingest UI behavior to avoid false-success state:
  - upload result now checks `data.stats.chunkCount` and sets error state when `chunkCount === 0`.
  - file list disables preview button for `processingStatus='failed'` docs and shows explicit tooltip.
- Validation after implementation:
  - `npm run test:run -- src/lib/ingest/__tests__/ocr-rescue.test.ts src/app/api/documents/__tests__/route.preview.test.ts` passed.
  - `npx tsc --noEmit --incremental false` passed.
  - `npm run lint` passed.
  - `npm run test:run` passed (`80/80`).
  - `npm run build` passed.
- Current status: code + tests complete for zero-chunk scan hardening; commit/push/deploy in progress.
- Zero-chunk hardening rollout completed:
  - commit: `6f035cb` pushed to `feat/rag-engine-switch`.
  - production deployment: `https://wenkugpt-copy-agizq24wt-nerotinys-projects.vercel.app`.
  - alias `https://wenkugpt-copy.vercel.app` points to this deployment.
- Current status: zero-chunk scan hardening is deployed to production; monitor runtime behavior on real scan uploads.
